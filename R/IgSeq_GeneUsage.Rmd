---
title: "Ig/BCR Seq data analysis-gene usage"
author: "Feng, Feng"
date: "`r Sys.Date()`"
header-includes:
    - \usepackage{setspace}\doublespacing
output: 
    pdf_document:
        fig_caption: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  tidy=FALSE,
  engine='R'
)
```
# 1. Purpose
We process the BCR data and analyze to show the gene usages in different samples, CVID vs. healthy control. There are also three different B cell populations, CD38 high, CD38 mid and CD38 low.

# 2. Data input
The data input were generated by 10x Genomics Cellranger vdj tool. Here we are using the output file named "filtered_contig_annotations.csv". There is one file for each B
cell population of each subject. There were all read in and saved as ".RData" files. In this project, we load them in and start the analysis.
```{r, eval=T}  
  #read the library
    library(dplyr)
    library(tidyverse)
    library(readr)
    library(here)
    library(compositions)
    library(ggfortify)

  #load data
  data.dir<-"Data" 
  load(here(data.dir,"BCR_vdj.RData"))
  #two variable/data frame read in
  #igData, colData
```

Show the meta data for samples and cell populatoins first

```{r, eval=T}
#show meta data
unique(colData[,-1]) 

```

Show the available data set (the beginning portion)

```{r, eval=T}
#show meta data
head(igData, n=10) 

```

With the data loaded, the first thing is to reformat the data to have the frequency of each IGHV gene segments for each object.

```{r, eval=T}
#let's first do heavy chain
IgHVs<- igData %>%
  filter(chain=="IGH", high_confidence==TRUE) 

#now only do IgHVs for now
IgHVs <- IgHVs %>%
  select( barcode, contig_id, v_gene, subs, cells, disease)

#put it into a wide format
IgHVs.long<- IgHVs %>% 
  group_by(v_gene, subs, cells, disease) %>%
  summarize(freq=n())
#k<-aggregate(IgHVs$barcode, by=list(IgHVs$v_gene, IgHVs$subs, IgHVs$cells), FUN=length) %>% View("f2")
#k[order(k$Group.1),] %>% View("f3")

IgHVs.wide<- IgHVs.long %>%
  pivot_wider(names_from=v_gene, values_from=freq, values_fill=0)

#show the data with frequencies
head(IgHVs.wide)

```

The next thing we want to do is to transform the frequency counts into composition data. So that we can do more things like PCA.

```{r}
#now let's got them into compositions
#clean up first to get rid of VGenes too few
IgHVs.wide.clean<- IgHVs.wide[,
  -(which(apply(IgHVs.wide[,-c(1,2,3)], 2, sum)<18))]

#now let's get the detection limit 
dl<-apply(IgHVs.wide.clean[,-c(1,2,3)],1, sum)
dl<-1/dl
IgHVs.wide.clean <- IgHVs.wide.clean [,-c(1,2,3)]
IgHVs.wide.clean<-as.data.frame(IgHVs.wide.clean)
rownames(IgHVs.wide.clean)<-paste0(IgHVs.wide$subs,"-", IgHVs.wide$cells)

dl<-rep(dl,dim(IgHVs.wide.clean)[2])
dl<-matrix(dl, ncol=dim(IgHVs.wide.clean)[2], nrow=dim(IgHVs.wide.clean)[1], byrow=F)
IgHVs.comp<-acomp(IgHVs.wide.clean)
IgHVs.comp<-zeroreplace(IgHVs.comp, d=dl, a=1/3)

IgHVs.clr<-clr(IgHVs.comp)
#usage.VGene.ilr<-ilr(usage.VGene.comp)

head(IgHVs.clr)
```

Now Let's do PCA, because the IGHV gene segment data are kind of high dimension. With PCA, we reduce the dimentsion and see the pattern better.

```{r}
dt.clr<-data.frame(IgHVs.clr)
IgHVs.dat<-cbind(IgHVs.clr, IgHVs.wide[,c("subs","cells","disease")])
pca.clrd<-prcomp(dt.clr, scale=T)
```

Now let's look at data projected onto the top two PC plane.

```{r}
g<-autoplot(pca.clrd,x=1,y=2,data=IgHVs.dat, 
    colour="subs",shape="cells",
        label=T, label.repel=T ,frame=F,  size=4,#frame.type="t"
      loadings=F, loadings.label=F, 
      loadings.label.size=4, loadings.colour="orange", 
      loadings.label.colour="orange"
    )
print(g)
```
This is very interesting. There are a few obvious impression about the first two PC projected data: 

- the variations between objects are bigger than between cell populations. Points belonging to the same object tend to stay together.

- the CVID patients are largely separated from the healthy control ( patients 1, 4, 6 are healthy controls; 2, 3, 5 are CVIDs)

- Within healthy control, sujbects stay far from each other. The CVID patients are closer, especially for patient 3 and 5.

- Dimension 1 (PC1) is more about the difference among CVIDs and also between CVIDs and healthy controls.

- Dimension 2 (PC2) is more about the difference among healthy controls.

I also show more dimensions.

```{r}
g34<-autoplot(pca.clrd,x=3,y=4,data=IgHVs.dat, 
    colour="subs",shape="cells",
        label=T, label.repel=T ,frame=F,  size=4,#frame.type="t"
      loadings=F, loadings.label=F, 
      loadings.label.size=4, loadings.colour="orange", 
      loadings.label.colour="orange"
    )
  g34
```  

Dimension 5 and 6    
```{r}
g56<-autoplot(pca.clrd,x=5,y=6,data=IgHVs.dat, 
    colour="subs",shape="cells",
        label=T , label.repel=T,frame=F,  size=4,#frame.type="t"
      loadings=F, loadings.label=F, 
      loadings.label.size=4, loadings.colour="orange", 
      loadings.label.colour="orange"
    )
g56
```
Dimension 7 and 8    

```{r}
g78<-autoplot(pca.clrd,x=7,y=8,data=IgHVs.dat, 
    colour="subs",shape="cells",
        label=T , label.repel=T,frame=F,  size=4,#frame.type="t"
      loadings=F, loadings.label=F, 
      loadings.label.size=4, loadings.colour="orange", 
      loadings.label.colour="orange"
    )
g78
```
The pattern of the data in other dimensions are not easy to discern, except that it seems that dimension 7 and 8 is more about differences in cell populations, because the same cell populations from different subjects stay closer. 

We definitely should look at them more to find the pattern. 

The above patterns are also confirmed by doing ANOVA statistical tests.

```{r}
####now let's do anova 
  library(car)
  options(contrasts = c("contr.sum", "contr.poly"))
#now we need to do individual ANOVAs on each PCs 
pc.uplim<-8
i<-1
model.ind.anova<-NULL

for(i in 1:pc.uplim)
{
  model.ind<-lm(pca.clrd$x[,i]~IgHVs.dat$disease*IgHVs.dat$cells);
  temp<-cbind(Anova(model.ind, type=2)[c(1:3),],PCs=i, effect=rownames(Anova(model.ind, type=2))[1:3])
    #temp<-cbind(Anova(model.ind, type=3)[c(1:8),],PCs=i, effect=rownames(Anova(model.ind, type=3))[1:8])
  rownames(temp)<-NULL
  temp$effect<-gsub("IgHVs.dat\\$","",temp$effect)
  temp$p.adj.ind<-p.adjust(temp$"Pr(>F)", method="BH")
  model.ind.anova<-rbind(model.ind.anova,temp)
  
} 
print(model.ind.anova)
```

Here we did a linear anova test with a full model testing, disease CVID effect, cell population effect and the interaction between them. As shown in the results, PC1 shows a significant disease effect, padj=0.015, meaning disease led to significant changes in IGHV gene segment usages. Also PC7 and PC8 show significant cell effects, padj<0.05, meaning different V gene segment usages among different B cell populations.

Lastly, we test for the individual gene segment usage difference using the ANOVA two-way analysis. 

```{r}
#now let's do the individual tests.
IgHVs.dat<-as.data.frame(IgHVs.dat)
model.IGHV.anova<-data.frame()
for(i in 1:(dim(IgHVs.dat)[2]-3))
{
  model.IGHV<-lm(IgHVs.dat[,i]~IgHVs.dat$disease*IgHVs.dat$cells)
  temp<-cbind(Anova(model.IGHV, type=2)[c(1:3),],IgHV=colnames(IgHVs.dat)[i], effect=rownames(Anova(model.ind, type=2))[1:3])
    #temp<-cbind(Anova(model.ind, type=3)[c(1:8),],PCs=i, effect=rownames(Anova(model.ind, type=3))[1:8])
  rownames(temp)<-NULL
  temp$effect<-gsub("IgHVs.dat\\$","",temp$effect)
  temp$p.adj.ind<-p.adjust(temp$"Pr(>F)", method="BH")
  model.IGHV.anova<-rbind(model.IGHV.anova,temp)
}
print(model.IGHV.anova)
```

Overall, it does show that CVID affects the IGHV segment usage. 

Note: Erik, could you please do the similar analysis for IGHJ, IGHD and similarly light chain usages?
Also want to mention, the R code used in this analysis are in IgSeq_geneUsage.R file.

```{r}
sessionInfo()
```

