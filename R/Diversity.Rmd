---
title: "Ig/BCR Seq data analysis-clone diversity"
author: "Feng, Feng"
date: "`r Sys.Date()`"
header-includes:
    - \usepackage{setspace}\doublespacing
output: 
    pdf_document:
        fig_caption: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  tidy=FALSE,
  engine='R'
)
```
# 1. Purpose
We process the BCR data and analyze to show clone diversity in different samples, CVID vs. healthy control. 
Here, in this first run we pooled data from different cell populations (CD38hi/mid/low) together.

Erik, you probably want to run the similar analysis on different cell populations to see how 
the diversity changes.

# 2. Data input
The data input were generated by 10x Genomics Cellranger vdj tool. The data were first mapped using Cellranger vdj tool and then
were processed by "enclone" to partition into clones. We read in the clonotype data and saved
as an rdata object,"clonotypeEnclone.RData". 

#--- started 3/12/2023 Feng

#the data were saved at IgSeq_data.R


```{r, eval=T} 

library(here)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(SpadeR)
library(iNEXT)


#load data
data.dir<-"Data"

load(here(data.dir,"clonotypeEnclone.RData"))

```
# 3. Data analysis
Starting the analysis by cleaning up the data to put them into correct format.

```{r, eval=T}
clones<-cloneData %>% select(group_id, group_ncells, clonotype_id,
	exact_subclonotype_id, cid, subs, disease )
clones.group<-clones %>% group_by(group_id,subs,disease) %>%
	summarize(n_cells=unique(group_ncells))
#turn it into wider format

clones.wide <- clones.group %>% select(-disease) %>%
	pivot_wider(names_from=subs, values_from=n_cells, 
		values_fill=0)
print(head(clones.wide))

```

Now, we rely on the SpadeR package to estimate species richness, which,
in our case, is the clone richness (or total number of clones in the subject).


```{r, eval=T}

#
d.S1<-ChaoSpecies(clones.wide$S1,"abundance", k=3, conf = 0.95)

d.S2<-ChaoSpecies(clones.wide$S6,"abundance", k=3, conf = 0.95)
```
Here we only show the results for the first two subjects
```{r, eval=T}
print(d.S1)
print(d.S2)
#
```

We further estimate the full diversity profile using the HILL numbers. 
HILL numbers is a unified family of diversity measures, which differ by
a single parameter q, the order of the diversity. When q=0, it is the clone/species
richness; q=1, it is the Shannon diversity; q=2, the Simpson diversity. 
The order q determines the contribution of clone size on the diversity measure.
When q is small, the diversity is less affected by the dominant clones (large clones),
and when q is big, it reflects more about the diversity of big (dominant) clones. 
We estimate the full profile using the iNext package.


```{r, eval=T} 

#d<-iNEXT(x=as.matrix(clones.wide[,-1]), q=0, datatype="abundance", 
#		size=NULL, endpoint=NULL, knots=500, se=TRUE, 
#		conf=0.95, nboot=50) 
#
#######please be CAREFUL, it takes long time (30~40mins) to run below
##
#d4<-iNEXT(x=as.matrix(clones.wide[,-1]), q=c(0,1,2,3,4), datatype="abundance", 
#		size=NULL, endpoint=20000, knots=1000, se=TRUE, 
#		conf=0.95, nboot=50) 
####
#save(d, d4, file="diversity.RData")
load(file=here(data.dir,"diversity.RData"))
#ggiNEXT(d4, type=1)#, facet.var="Order.q")
#orignial
#ggiNEXT(d4, type=1)#, facet.var="Order.q")
group.info<-as.data.frame(unique(clones.group[,c(2:3)]))
rownames(group.info)<-group.info$subs
d4_2<-d4$AsyEst
d4_2$newDiv<-factor(d4_2$Diversity, levels=c("Species richness",
		"Shannon diversity", "Simpson diversity"))
d4_2$newDiv<-as.integer(d4_2$newDiv)
d4_2$disease<-group.info[d4_2$Assemblage,"disease"]
ggplot(d4_2, aes(x=newDiv, y=Estimator,colour=disease))+
	geom_line(aes(linetype=Assemblage),linewidth=1.2)+
	geom_point(aes(shape=Assemblage),size=5)

```

So far, we have estimated the diversity and show the diversity profiles are mixed
together for the subjects with or without CVID. There is one factor that we 
need to control to futher dissecting the effects. It is the sample size or total
number of sequences used to estimate the diversity. It has been known that
the sample size affects the diversity estimation and incomplete sampling leads to 
underestimate the diversity measures. This is especially true for the diversity measure 
with small q values. Therefore, we need to rescale/normalize the HILL numbers
with the sample size.


```{r, eval=T}
####estimator
#S1
d4.trans<-d4$AsyEst
index<-4
subj<-1
dataInfo<-d4$DataInfo
rownames(dataInfo)<-dataInfo$Assemblage
d4.trans<-cbind(d4.trans,dataInfo[d4.trans$Assemblage,"n"])
names(d4.trans)[dim(d4.trans)[2]]<-"n"

scale.index<-dim(d4.trans)[2]

for(i in 1:length(unique(d4.trans$Assemblage)))
{
	d4.trans[c(1:3)+3*(i-1),index]<-d4$AsyEst[c(1:3)+3*(i-1),index]/d4.trans[3*(i-1)+1,scale.index]
}


###now let's do stats
group.info<-as.data.frame(unique(clones.group[,c(2:3)]))
rownames(group.info)<-group.info$subs

#transformed
d4.trans_2<-d4.trans
d4.trans_2<-cbind(d4.trans_2, d4_2[,c("newDiv",
		"disease"
		)])

ggplot(d4.trans_2, aes(x=newDiv, y=Estimator,colour=disease))+
	geom_line(aes(linetype=Assemblage),linewidth=1.2)+
	geom_point(aes(shape=Assemblage),size=5)
```

Next let's run wilcoxon test to compare the diversity measures at different orders


First, q=0

```{r, eval=T}
#q=0

#run stats using wilcoxn test
d4.q0<-d4.trans_2 %>% 
	filter(Diversity=="Species richness")

res <- wilcox.test(Estimator ~ disease, data = d4.q0,
                   exact = FALSE)
print(res)
```

q=1

```{r, eval=T}
#q=0

#run stats using wilcoxn test
d4.q1<-d4.trans_2 %>% 
	filter(Diversity=="Shannon diversity")

res <- wilcox.test(Estimator ~ disease, data = d4.q1,
                   exact = FALSE)
print(res)
```
q=2, the result is the same.

Although the p value is 0.08, considering we only have 3 samples each group, 
it can be better.



Lastly, we can try to estimate the full profile using SpadeR, 
which is not necessary for now.

```{r, eval=T}
###diversity using space for estimating high order.
library(SpadeR)
#Don't run below. it takes quite long. What they do is 
#to estimate the full diversity profile using SpadeR.
#Suppose to do beyond q=2. It is not necessary for now.
#
#ds1<-Diversity(clones.wide$S1,"abundance", q=seq(1,4,0.5))

#ds2<-Diversity(clones.wide$S2,"abundance", q=seq(1,3.5,0.5))

#ds3<-Diversity(clones.wide$S3,"abundance", q=seq(1,3,0.5))

#ds4<-Diversity(clones.wide$S4,"abundance", q=seq(1,4,0.5))

#ds5<-Diversity(clones.wide$S5,"abundance", q=seq(1,3,0.5))

#ds6<-Diversity(clones.wide$S6,"abundance", q=seq(1,3,0.5))

```

# Conclusion/Thoughts

A little suprised that the diversity profile for CVID subjects show
high values than the healthy controls. One possible explanation is that
CVID results in less killing of B cells (?). I don't know.

Two caveats are that the sample size is small (3 mice each group) and the sampling 
is not complete (not enough number of sequences each subject). 

Erik, could you please run similar analyses as what I have done here, but separate
samples into different B cell populatoins?

```{r, eval=T}
sessionInfo()
```  

